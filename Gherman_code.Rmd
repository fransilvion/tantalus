---
title: 'Serratus: new format'
author: "German Novakovskiy"
date: "May 27, 2020"
output: html_document
---

```{r, include=FALSE}
# Acquire data (run once)
system('mkdir -p 200527')
system('aws s3 sync s3://serratus-public/out/200525_vert/summary/ 200527/')
```

```{r setup, include=FALSE}
#library("RSQLite")
#library("jsonlite")
library("tantalus")
library("ggplot2")
library("gridExtra")
library("dplyr")
#for exploring
library("plotly")
library("grid")
library("scales")
library("viridis")
library("ggpubr")
```

```{r}

```

```{r, include = FALSE}
#DATA_PATH='../200528_viro/'
#DATA_PATH='../200525_vert/'
#DATA_PATH='../200530_hu1/'
#DATA_PATH='../200606_mamm/'
DATA_PATH='../200606_hu2/'
sumWheres <- paste0( DATA_PATH,
                     system( paste0("ls ", DATA_PATH), intern = T ))

#ZOO <- readSerratus( sumWheres )

#for (f in sumWheres){
  #print(f)
  #test <- readSerratus( f )
#}

start.time <- Sys.time()

#ZOO <- readSerratus( sumWheres )
HU2 <- readSerratus( sumWheres )

end.time <- Sys.time()
time.taken <- end.time - start.time
time.taken

#save(ZOO, file="../VIRO.RData")
#save(VERT, file="../VERT.RData")
#save(HU1, file="../HU1.RData")
#save(MAMM, file="../MAMM.RData")
#save(HU2, file="../HU2.RData")

#load("../MAMM.RData")
load("../HU2.RData")

#magor_problem <- c("../200528_viro/ERR2002982.summary")
#x <- readSerratus( magor_problem )

x <- readSerratus( "../test.summary" )

```

```{r}
familyScore(HU2, "Coronaviridae", log=T)
```

```{r}
#PCTID vs fscore
library(RColorBrewer)
blues <- colorRampPalette(c('light blue', 'dark blue'))

#new plot
family_df <- HU2@family %>% filter(family %in% c("Coronaviridae"))
#family_df <- MAMM@family %>% filter(family %in% c("Coronaviridae"))

test <- family_df$score
test2 <- sapply(test, function(x){
  if ((x <= 100) & (x > 95)){
  return("95-100")
  } else if ((x <= 95) & (x > 85)){
    return("85-95")
  } else if ((x <= 85) & (x > 75)){
    return("75-85")
  } else if ((x <= 75) & (x > 65)){
    return("65-75")
  } else if ((x <= 65) & (x > 55)){
    return("55-65")
  } else if ((x <= 55) & (x > 45)){
    return("45-55")
  } else if ((x <= 45) & (x > 35)){
    return("35-45")
  } else if ((x <= 35) & (x > 25)){
    return("25-35")
  } else if ((x <= 25) & (x > 15)){
    return("15-25")
  } else if ((x <= 15) & (x > 5)){
    return("5-15")
  } else {
    return("0-5")
  }
})

test2 <- factor(test2, levels = c("0-5", "5-15", "15-25", "25-35", "35-45", "45-55", "55-65", "65-75", "75-85", "85-95", "95-100"))

family_df$score_intervals <- test2

#ggplot(family_df, aes(pctid, fill = score_intervals)) +
#  geom_histogram(color="black", bins = 30) +
  #scale_fill_manual(values = c(blues(length(levels(test2))))) +
#  scale_fill_viridis(discrete=TRUE)+
  #scale_y_log10() +
#  yscale("log10", .format = TRUE) +
#  theme_bw()


ggplot(family_df %>% group_by(pctid,score_intervals) %>% summarize(n=n(), log10n = log10(n() + 1)), aes(pctid, log10n,fill = score_intervals)) +
  geom_bar(color="black",stat = "identity") +
  scale_fill_viridis(discrete=TRUE) + 
  theme_bw() +
  labs(title = "Coronaviridae")
```

## FSCORE vs pctid

```{r}
#FSCORE vs pctid
library(RColorBrewer)
blues <- colorRampPalette(c('light blue', 'dark blue'))

#new plot
family_df <- HU2@family %>% filter(family %in% c("Coronaviridae"))
#family_df <- MAMM@family %>% filter(family %in% c("Coronaviridae"))

test <- family_df$pctid
test2 <- sapply(test, function(x){
  if ((x <= 100) & (x > 97)){
  return("97-100")
  } else if ((x <= 97) & (x > 94)){
    return("94-97")
  } else if ((x <= 94) & (x > 91)){
    return("91-94")
  } else if ((x <= 91) & (x > 88)){
    return("88-91")
  } else if ((x <= 88) & (x > 85)){
    return("85-88")
  } else if ((x <= 85) & (x > 82)){
    return("82-85")
  } else {
    return("<82")
  }
})

test2 <- factor(test2, levels = c("<82", "82-85", "85-88", "88-91", "91-94", "94-97", "97-100"))

family_df$pctid_intervals <- test2

y <- factor(family_df$pctid, levels = sort(unique(family_df$pctid), decreasing = F))
family_df$pctd <- y

#ggplot(family_df, aes(score, fill = pctid_intervals)) +
#  geom_histogram(color="black", bins = 30) +
#  scale_fill_viridis(discrete=TRUE)+
  #scale_y_continuous(trans = log10_trans(),
  #  breaks = trans_breaks("log10", function(x) 10^x),
  #  labels = trans_format("log10", math_format(10^.x))) +
#  yscale("log10", .format = TRUE)+
#  theme_bw()

#Possible way around
ggplot(family_df %>% group_by(score,pctid_intervals) %>% summarize(n=n(), log10n = log10(n() + 1)), aes(score, log10n,fill = pctid_intervals)) +
  geom_bar(color="black",stat = "identity") +
  scale_fill_viridis(discrete=TRUE) + 
  theme_bw() +
  labs(title = "Coronaviridae")

```


```{r}
x <- familyScorPctID(HU2, "Coronaviridae")
x
```

```{r}
p1 <- familyPctID(HU2, "Coronaviridae", score_threshold = 0, title="Coronaviridae - all", x1=70, x2=100, log=T)
p2 <- familyPctID(HU2, "Coronaviridae", score_threshold = 50, title="Coronaviridae - 50+", x1=70, x2=100, log=T)
p3 <- familyPctID(HU2, "Coronaviridae", score_threshold = 60, title="Coronaviridae - 60+", x1=70, x2=100, log=T)
p4 <- familyPctID(HU2, "Coronaviridae", score_threshold = 70, title="Coronaviridae - 70+", x1=70, x2=100, log=T)
p5 <- familyPctID(HU2, "Coronaviridae", score_threshold = 80, title="Coronaviridae - 80+", x1=70, x2=100, log=T)
p6 <- familyPctID(HU2, "Coronaviridae", score_threshold = 90, title="Coronaviridae - 90+", x1=70, x2=100, log=T)

grid.newpage()
grid.draw(rbind(ggplotGrob(p1),
                ggplotGrob(p2),
                ggplotGrob(p3),
                ggplotGrob(p4),
                ggplotGrob(p5),
                ggplotGrob(p6),
                size = "last"))
```

## Chao-1 analysis

Building an OTU-SRA correspondance file:
```{r}
load("../VIRO.RData")
#
load("../VERT.RData")
#
load("../HU1.RData")

otus <- read.table("../data/otus92.tsv", sep="\t", stringsAsFactors = F)
colnames(otus) <- c("OTU", "NAME")
cov3ma <- read.table("../data/cov3ma.sumzer.tsv", sep="\t", stringsAsFactors = F, quote = "", comment.char = "$")
```

```{r}
################################################################################################################
#VIRO
################################################################################################################
VIRO <- ZOO
rm(ZOO)

Coron_viro <- VIRO@family %>% filter(family %in% c("Coronaviridae")) %>%
                         filter(score >= 80) %>%
                         filter(pctid >= 95)

accessions <- as.character(Coron_viro$top)
accessions <- sapply(accessions, function(x) { unlist(strsplit(x, "[.]"))[1] })
Coron_viro$NAME <- accessions
Coron_viro_short <- Coron_viro %>% dplyr::select("sra", "NAME")

otus_viro <- merge(Coron_viro_short, otus, by="NAME")

################################################################################################################
#VERT
################################################################################################################
Coron_vert <- VERT@family %>% filter(family %in% c("Coronaviridae")) %>%
                         filter(score >= 80) %>%
                         filter(pctid >= 95)

accessions <- as.character(Coron_vert$top)
accessions <- sapply(accessions, function(x) { unlist(strsplit(x, "[.]"))[1] })
Coron_vert$NAME <- accessions
Coron_vert_short <- Coron_vert %>% dplyr::select("sra", "NAME")

otus_vert <- merge(Coron_vert_short, otus, by="NAME")

################################################################################################################
#VIRO
################################################################################################################
Coron_hu1 <- HU1@family %>% filter(family %in% c("Coronaviridae")) %>%
                         filter(score >= 80) %>%
                         filter(pctid >= 95)

accessions <- as.character(Coron_hu1$top)
accessions <- sapply(accessions, function(x) { unlist(strsplit(x, "[.]"))[1] })
Coron_hu1$NAME <- accessions
Coron_hu1_short <- Coron_hu1 %>% dplyr::select("sra", "NAME")

otus_hu1 <- merge(Coron_hu1_short, otus, by="NAME")

```


Count number of datasets per otu (species):
```{r}
otus_datasets <- rbind(otus_viro, otus_vert, otus_hu1)
otus_datasets <- unique(otus_datasets)

otus_species <- unique(otus$OTU)

test <- sapply(otus_species, function(x) { otus_datasets %>% filter(OTU == x) %>% nrow() })

res_abundance <- data.frame(OTU = as.character(), Number_of_datasets = as.numeric())
for (otu_num in otus_species){
  name_of_otu <- paste("OTU", otu_num, sep="")
  num_of_datasets <- otus_datasets %>% filter(OTU == otu_num) %>% nrow()
  
  interim_res <- data.frame(OTU = name_of_otu, Number_of_datasets = num_of_datasets)
  
  res_abundance <- rbind(res_abundance, interim_res)
}

res_abundance <- res_abundance[order(-res_abundance$Number_of_datasets),]

write.table(res_abundance, file="../data/otu_abundance.tsv", quote=F, sep="\t", row.names = F)
```
