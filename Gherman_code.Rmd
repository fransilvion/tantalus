---
title: 'Serratus: new format'
author: "German Novakovskiy"
date: "May 27, 2020"
output: html_document
---

```{r, include=FALSE}
# Acquire data (run once)
system('mkdir -p 200527')
system('aws s3 sync s3://serratus-public/out/200525_vert/summary/ 200527/')
```

```{r setup, include=FALSE}
#library("RSQLite")
#library("jsonlite")
library("tantalus")
library("ggplot2")
library("gridExtra")
library("dplyr")
#for exploring
library("plotly")
library("grid")

```

```{r}

```

```{r, include = FALSE}
DATA_PATH='../200528_viro/'
sumWheres <- paste0( DATA_PATH,
                     system( paste0("ls ", DATA_PATH), intern = T ))

#ZOO <- readSerratus( sumWheres )

#for (f in sumWheres){
  #print(f)
  #test <- readSerratus( f )
#}

start.time <- Sys.time()

ZOO <- readSerratus( sumWheres )

end.time <- Sys.time()
time.taken <- end.time - start.time
time.taken

save(ZOO, file="../ZOO.RData")

load("../ZOO.RData")

#magor_problem <- c("../200528_viro/ERR2002982.summary")
#x <- readSerratus( magor_problem )

x <- readSerratus( "../test.summary" )

```

```{r}
#TEST
families <- unique(ZOO@family$family)
Coronaviridae <- ZOO@family %>% filter(family %in% c("Coronaviridae"))

#fig <- plot_ly(x = Coronaviridae$score, type = "histogram")
#fig

ggplot(data=Coronaviridae, aes(Coronaviridae$score)) + 
  geom_histogram(fill="blue", bins = 100) +
  theme_bw() +
  labs(x = "Family score") +
  labs(title = "Coronaviridae family")
```

```{r}
#TEST
#familyScorPctID function – input serratus objects; output – ggplot with scatter plot
ggplot(data=Coronaviridae, aes(x=Coronaviridae$score, y=Coronaviridae$pctid)) +
  geom_point(size=3, color="blue") + 
  theme_bw() +
  labs(x = "Family score", y = "Percentage identity") +
  labs(title = "Coronaviridae family")
```
```{r}
ggplot(data=Coronaviridae, aes(x=Coronaviridae$score, y=Coronaviridae$pctid)) +
  geom_hex(bins=30) + 
  theme_bw() +
  labs(x = "Family score", y = "Percentage identity") +
  labs(title = "Coronaviridae family")
```

```{r}
p <- ggplot(data=Coronaviridae, aes(x=Coronaviridae$score, y=Coronaviridae$pctid)) +
  geom_point(size=3, color="blue") + 
  theme_bw() +
  labs(x = "Family score", y = "Percentage identity") +
  labs(title = "Coronaviridae family")

ggExtra::ggMarginal(p, type = "histogram")
```

```{r}
p1 <- ggplot(data=Coronaviridae, aes(pctid)) + 
  geom_histogram( bins = 30) +
  theme_bw() + xlim(c(75,100)) +
  labs(x = "Percentage Identity") +
  labs(title = "Coronaviridae - all")
p2 <- ggplot(data=Coronaviridae[which(Coronaviridae$score >= 50), ], aes(pctid)) + 
  geom_histogram( bins = 30) +
  theme_bw() + xlim(c(75,100)) +
  labs(x = "Percentage Identity") +
  labs(title = "Coronaviridae - 50+")
p3 <- ggplot(data=Coronaviridae[which(Coronaviridae$score >= 60), ], aes(pctid)) + 
  geom_histogram( bins = 30) +
  theme_bw() + xlim(c(75,100)) +
  labs(x = "Percentage Identity") +
  labs(title = "Coronaviridae - 60+")
p4 <- ggplot(data=Coronaviridae[which(Coronaviridae$score >= 70), ], aes(pctid)) + 
  geom_histogram( bins = 30) +
  theme_bw() + xlim(c(75,100)) +
  labs(x = "Percentage Identity") +
  labs(title = "Coronaviridae - 70+")
p5 <- ggplot(data=Coronaviridae[which(Coronaviridae$score >= 80), ], aes(pctid)) + 
  geom_histogram( bins = 30) +
  theme_bw() + xlim(c(75,100)) +
  labs(x = "Percentage Identity") +
  labs(title = "Coronaviridae - 80+")
p6 <- ggplot(data=Coronaviridae[which(Coronaviridae$score >= 90), ], aes(pctid)) + 
  geom_histogram( bins = 30) +
  theme_bw() + xlim(c(75,100)) +
  labs(x = "Percentage Identity") +
  labs(title = "Coronaviridae - 90+")
p7 <- ggplot(data=Coronaviridae[which(Coronaviridae$score >= 90), ], aes(pctid)) + 
  geom_histogram( bins = 30) +
  theme_bw() + xlim(c(75,100)) +
  labs(x = "Percentage Identity") +
  labs(title = "Coronaviridae - 90+")
p8 <- ggplot(data=Coronaviridae[which(Coronaviridae$score >= 90), ], aes(pctid)) + 
  geom_histogram( bins = 30) +
  theme_bw() + xlim(c(75,100)) +
  labs(x = "Percentage Identity") +
  labs(title = "Coronaviridae - 90+")


grid.newpage()
grid.draw(rbind(ggplotGrob(p1),
                ggplotGrob(p2),
                ggplotGrob(p3),
                ggplotGrob(p4),
                ggplotGrob(p5),
                ggplotGrob(p6),
                ggplotGrob(p7),
                ggplotGrob(p8),
                 ggplotGrob(p8),
                 ggplotGrob(p8),
                size = "last"))
```

